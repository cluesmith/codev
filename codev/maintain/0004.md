# Maintenance Run 0004

## Metadata
- **Date**: 2025-12-28
- **Base Commit**: 7591ab9 (from run 0003)
- **PR**: #124
- **Scope**: full

## Changes Since Last Run

**198 commits since last maintenance** covering:
- v1.3.0 Doric release
- v1.4.x releases (v1.4.0 Eichler through v1.4.10)
- v1.5.x releases (v1.5.1 through v1.5.8 Florence)
- 16 new reviews
- Major features: Secure Remote Access (0062), STL Viewer (0061), Dashboard improvements (0058-0060, 0063), File Browser (0055), Generate Image Tool (0054), and more

Key commits:
```
67d3a80 fix(remote): preserve query string in annotation proxy for file refresh
64b9c46 chore: release v1.5.8
b0233aa Release @cluesmith/codev@1.5.2 (Florence)
fa0e8b8 Release @cluesmith/codev@1.4.0 (Eichler)
afd5d02 Release @cluesmith/codev@1.3.0 (Doric)
8488bb6 [Spec 0062] Secure Remote Access
6eaf2fa [Spec 0061] STL Viewer with 3MF support
cae126d [Spec 0060] Dashboard modularization
188480e [Spec 0059] Daily activity summary
d3cc518 [Spec 0058] File search autocomplete
a3e6c38 [Spec 0056] Consult types refactor
a890ba5 [Spec 0057] Dashboard tab overhaul
62c8ff9 [Spec 0055] Dashboard file browser
465e95b [Spec 0054] Generate image tool
7c04fa8 [Spec 0053] af open image support
```

## Tasks Completed

### Code Hygiene
- [x] Dead code removal (ts-prune) - No actionable findings
- [x] Unused dependencies (depcheck) - No issues (tsx/typescript are used)
- [x] Dependency audit (npm audit) - 0 vulnerabilities
- [x] Code duplication analysis (jscpd) - 26 clones found, 2.48% duplication

### Documentation
- [ ] arch.md sync
- [ ] lessons-learned.md generation (16 new reviews)
- [x] CLAUDE.md / AGENTS.md sync - Already in sync
- [ ] Documentation pruning

### Project Tracking
- [ ] projectlist.md status updates

## Findings

### Code Duplication Analysis (jscpd)

**Summary**: 26 clones found, 2.48% duplication (3155 tokens)

#### High-Value Refactoring Candidates

**1. Dashboard JS - openFile duplication** (14 lines)
- `templates/dashboard/js/files.js:189-203` duplicates `main.js:35-49`
- **Recommendation**: Extract `openFileTab(filePath)` utility to `utils.js`

**2. Dashboard JS - menu keyboard navigation** (17 lines)
- `dialogs.js:113-130` duplicates `tabs.js:499-516`
- **Recommendation**: Extract generic `handleMenuKeydown(menuId, hideFunction)` to `utils.js`

**3. Dashboard JS - activity rendering** (52+ lines)
- `activity.js:65-121` largely duplicates `activity.js:137-189`
- `renderActivityTabContent` vs `renderActivitySummary` nearly identical
- **Recommendation**: Extract shared rendering logic to `renderActivityContent(data, containerId, isTab)`

**4. TypeScript - loadRolePrompt** (3 files)
- `commands/start.ts`, `commands/spawn.ts`, `commands/architect.ts`
- **Recommendation**: Extract to `utils/roles.ts`

**5. TypeScript - confirm() prompt** (2 files)
- `commands/init.ts` and `commands/adopt.ts`
- **Recommendation**: Extract to `lib/prompts.ts`

**6. TypeScript - server utilities** (3 files)
- `escapeHtml`, `parseJsonBody`, `isRequestAllowed` duplicated across:
  - `servers/dashboard-server.ts`
  - `servers/tower-server.ts`
  - `servers/open-server.ts`
- **Recommendation**: Extract to `servers/utils.ts`

**7. TypeScript - tmux configuration** (2 files)
- `commands/spawn.ts:297-310` duplicates `commands/start.ts:78-97`
- Tmux mouse/clipboard setup duplicated
- **Recommendation**: Extract to `utils/tmux.ts`

#### Lower Priority (Test File Duplication)

Test files have expected duplication for setup/teardown. Not actionable.

### ts-prune Results

All identified "unused" exports are intentionally public API:
- `getBuildersByStatus`, `getUtil`, `TmuxSession` - public API
- `escapeHtml` in projectlist-parser - used by tests
- Various command re-exports - CLI command routing

**Conclusion**: No actual dead code found.

### Deferred Refactoring

The above duplications are documented for future cleanup. Refactoring during MAINTAIN adds risk without clear spec. Each duplication cluster could become a TICK amendment:

| Duplication | Estimated Effort | Suggested TICK |
|-------------|------------------|----------------|
| Dashboard openFile | 30 min | TICK 0060-002 |
| Dashboard menu keydown | 20 min | TICK 0060-003 |
| Activity rendering | 45 min | TICK 0059-002 |
| loadRolePrompt | 30 min | TICK 0002-002 |
| Server utilities | 45 min | TICK 0002-003 |
| Prompts (init/adopt) | 20 min | TICK 0039-006 |

## Documentation Changes

### arch.md
| Section | Action | Reason |
|---------|--------|--------|
| Dashboard UI | Updated | Modularization structure, hot reload, new features |
| API Endpoints | Added | /api/files, /api/activity-summary, /api/hot-reload, /terminal/:id |
| Templates | Updated | Added dashboard/, open.html, 3d-viewer.html, tower.html |
| Commands | Added | tunnel.ts, architect.ts, db.ts, generate-image.ts |
| Recent Changes | Updated | Added v1.5.x Florence features |
| Last Updated | Updated | 2025-12-28 (Maintenance Run 0004) |

### lessons-learned.md
| Section | Action | Reason |
|---------|--------|--------|
| Testing | Added 2 | From 0056, 0059 reviews |
| Architecture | Added 3 | From 0060, 0061-002 reviews |
| Process | Added 4 | From 0054, 0057, 0059 reviews |
| Tools | Added 2 | From 0053, 0061-001 reviews |
| Security | Added 3 | From 0055, 0061-002, 0062 reviews |
| UI/UX | Added 7 | From 0053-0058, 0002-001 reviews |
| 3-Way Reviews | Added (new section) | From 0054, 0061-002, 0062 reviews |

### CLAUDE.md / AGENTS.md
| Section | Action | Reason |
|---------|--------|--------|
| N/A | Already in sync | Both files identical (757 lines) |

## Deferred

<!-- To be populated if any items are deferred -->

## Validation

- [x] Tests pass (270 tests passed)
- [x] Build succeeds (tsc && copy-skeleton)
- [x] No lint issues reported

## Summary

Maintenance Run 0004 covered 198 commits since v1.2.0-Cordoba (commit 7591ab9), spanning releases v1.3.0 Doric through v1.5.8 Florence.

**Key Accomplishments:**
- **Code Hygiene**: Deep analysis with ts-prune, depcheck, jscpd. No dead code found. Documented 7 code duplication clusters for future TICK amendments (2.48% duplication rate).
- **Documentation Updates**:
  - Updated arch.md with v1.5.x features (dashboard modularization, file browser, activity summary, remote access, 3D viewer)
  - Added 23 new lessons to lessons-learned.md from 16 new reviews
  - Added v1.5.x and v1.6.0 releases to projectlist.md
  - CLAUDE.md and AGENTS.md already in sync
- **No Breaking Changes**: All changes are documentation-only

**Deferred Work**: Code duplication refactoring documented but not implemented to avoid risk. Each cluster has a suggested TICK amendment for future cleanup.
