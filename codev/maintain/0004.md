# Maintenance Run 0004

## Metadata
- **Date**: 2025-12-28
- **Base Commit**: 7591ab9 (from run 0003)
- **PR**: #124
- **Scope**: full

## Changes Since Last Run

**198 commits since last maintenance** covering:
- v1.3.0 Doric release
- v1.4.x releases (v1.4.0 Eichler through v1.4.10)
- v1.5.x releases (v1.5.1 through v1.5.8 Florence)
- 16 new reviews
- Major features: Secure Remote Access (0062), STL Viewer (0061), Dashboard improvements (0058-0060, 0063), File Browser (0055), Generate Image Tool (0054), and more

Key commits:
```
67d3a80 fix(remote): preserve query string in annotation proxy for file refresh
64b9c46 chore: release v1.5.8
b0233aa Release @cluesmith/codev@1.5.2 (Florence)
fa0e8b8 Release @cluesmith/codev@1.4.0 (Eichler)
afd5d02 Release @cluesmith/codev@1.3.0 (Doric)
8488bb6 [Spec 0062] Secure Remote Access
6eaf2fa [Spec 0061] STL Viewer with 3MF support
cae126d [Spec 0060] Dashboard modularization
d3cc518 [Spec 0058] File search autocomplete
a3e6c38 [Spec 0056] Consult types refactor
a890ba5 [Spec 0057] Dashboard tab overhaul
62c8ff9 [Spec 0055] Dashboard file browser
465e95b [Spec 0054] Generate image tool
7c04fa8 [Spec 0053] af open image support
```

## Tasks Completed

### Code Hygiene
- [x] Dead code removal (ts-prune) - No actionable findings
- [x] Unused dependencies (depcheck) - No issues (tsx/typescript are used)
- [x] Dependency audit (npm audit) - 0 vulnerabilities
- [x] Code duplication analysis (jscpd) - 26 clones found, 2.48% duplication

### Documentation
- [x] arch.md sync - Updated with v1.5.x features
- [x] lessons-learned.md generation (16 new reviews) - Consolidated and reordered by importance
- [x] CLAUDE.md / AGENTS.md sync - Already in sync
- [x] Documentation pruning - Removed redundancy with CLAUDE.md

### Project Tracking
- [x] projectlist.md status updates - Added v1.5.x and v1.6.0 releases

### Code Deduplication (Completed - ALL 7 duplication clusters resolved)

**TypeScript Deduplication:**
- [x] Server utilities extracted to `utils/server-utils.ts` (escapeHtml, parseJsonBody, isRequestAllowed)
- [x] Role utilities extracted to `utils/roles.ts` (loadRolePrompt, findRolePromptPath)
- [x] Scaffold utilities extracted to `lib/scaffold.ts` (createUserDirs, copyProjectlist, copyResourceTemplates, etc.)
- [x] CLI prompts extracted to `lib/cli-prompts.ts` (prompt, confirm)
- [x] Updated dashboard-server.ts, tower-server.ts, open-server.ts to use shared utilities
- [x] Updated start.ts, spawn.ts, architect.ts to use shared role utilities
- [x] Updated init.ts, adopt.ts to use shared scaffold and CLI prompt utilities
- [x] Added 46 new tests (22 for server-utils, 7 for roles, 17 for scaffold)

**Dashboard JS Deduplication:**
- [x] Extracted `openFileTab(filePath, options)` to `utils.js` - consolidates file opening from main.js, files.js, dialogs.js
- [x] Extracted `handleMenuKeydown(event, menuId, itemClass, hideFunction, options)` to `utils.js` - consolidates keyboard navigation from dialogs.js, tabs.js
- [x] Updated main.js, files.js, dialogs.js, tabs.js to use shared utilities
- Note: Activity-related utilities were removed in Spec 0074 (feature removed)

**Line reduction summary:**
- init.ts: 249 → 138 lines (-111 lines, 45% reduction)
- adopt.ts: 313 → 195 lines (-118 lines, 38% reduction)
- Dashboard JS: 268 lines removed, 216 added (net -52 lines, logic centralized)
- Total: **281 lines of duplicate code removed** across TypeScript and JavaScript

## Findings

### Code Duplication Analysis (jscpd)

**Summary**: 26 clones found, 2.48% duplication (3155 tokens)

#### High-Value Refactoring Candidates

**1. Dashboard JS - openFile duplication** (14 lines)
- `templates/dashboard/js/files.js:189-203` duplicates `main.js:35-49`
- **Recommendation**: Extract `openFileTab(filePath)` utility to `utils.js`

**2. Dashboard JS - menu keyboard navigation** (17 lines)
- `dialogs.js:113-130` duplicates `tabs.js:499-516`
- **Recommendation**: Extract generic `handleMenuKeydown(menuId, hideFunction)` to `utils.js`

**3. Dashboard JS - activity rendering** (52+ lines) [REMOVED in Spec 0074]
- Entire activity feature was removed as never used in practice

**4. TypeScript - loadRolePrompt** (3 files)
- `commands/start.ts`, `commands/spawn.ts`, `commands/architect.ts`
- **Recommendation**: Extract to `utils/roles.ts`

**5. TypeScript - confirm() prompt** (2 files)
- `commands/init.ts` and `commands/adopt.ts`
- **Recommendation**: Extract to `lib/prompts.ts`

**6. TypeScript - server utilities** (3 files)
- `escapeHtml`, `parseJsonBody`, `isRequestAllowed` duplicated across:
  - `servers/dashboard-server.ts`
  - `servers/tower-server.ts`
  - `servers/open-server.ts`
- **Recommendation**: Extract to `servers/utils.ts`

**7. TypeScript - tmux configuration** (2 files)
- `commands/spawn.ts:297-310` duplicates `commands/start.ts:78-97`
- Tmux mouse/clipboard setup duplicated
- **Recommendation**: Extract to `utils/tmux.ts`

#### Lower Priority (Test File Duplication)

Test files have expected duplication for setup/teardown. Not actionable.

### ts-prune Results

All identified "unused" exports are intentionally public API:
- `getBuildersByStatus`, `getUtil`, `TmuxSession` - public API
- `escapeHtml` in projectlist-parser - used by tests
- Various command re-exports - CLI command routing

**Conclusion**: No actual dead code found.

### Deferred Refactoring

**All 7 duplication clusters have been resolved:**

| Duplication | Estimated Effort | Status |
|-------------|------------------|--------|
| Dashboard openFile | 30 min | ✅ **COMPLETED** - Extracted to `utils.js` |
| Dashboard menu keydown | 20 min | ✅ **COMPLETED** - Extracted to `utils.js` |
| Activity rendering | 45 min | ✅ **COMPLETED** → Removed in Spec 0074 |
| loadRolePrompt | 30 min | ✅ **COMPLETED** - Extracted to `utils/roles.ts` |
| Server utilities | 45 min | ✅ **COMPLETED** - Extracted to `utils/server-utils.ts` |
| Scaffolding (init/adopt) | 45 min | ✅ **COMPLETED** - Extracted to `lib/scaffold.ts` |
| CLI prompts (init/adopt) | 20 min | ✅ **COMPLETED** - Extracted to `lib/cli-prompts.ts` |

**Remaining tmux configuration duplication** (spawn.ts/start.ts) was identified but not addressed as it's minimal (~15 lines) and the two contexts have diverging requirements.

## Documentation Changes

### arch.md
| Section | Action | Reason |
|---------|--------|--------|
| Dashboard UI | Updated | Modularization structure, hot reload, new features |
| API Endpoints | Added | /api/files, /api/hot-reload, /terminal/:id (note: /api/activity-summary was later removed by Spec 0074) |
| Templates | Updated | Added dashboard/, open.html, 3d-viewer.html, tower.html |
| Commands | Added | tunnel.ts, architect.ts, db.ts, generate-image.ts |
| Recent Changes | Updated | Added v1.5.x Florence features |
| Last Updated | Updated | 2025-12-28 (Maintenance Run 0004) |

### lessons-learned.md
| Section | Action | Reason |
|---------|--------|--------|
| Testing | Added 2 | From 0056 reviews |
| Architecture | Added 3 | From 0060, 0061-002 reviews |
| Process | Added 4 | From 0054, 0057 reviews |
| Tools | Added 2 | From 0053, 0061-001 reviews |
| Security | Added 3 | From 0055, 0061-002, 0062 reviews |
| UI/UX | Added 7 | From 0053-0058, 0002-001 reviews |
| 3-Way Reviews | Added (new section) | From 0054, 0061-002, 0062 reviews |

### CLAUDE.md / AGENTS.md
| Section | Action | Reason |
|---------|--------|--------|
| N/A | Already in sync | Both files identical (757 lines) |

## Deferred

<!-- To be populated if any items are deferred -->

## Validation

- [x] Tests pass (316 tests passed - 270 original + 46 new dedup tests)
- [x] Build succeeds (tsc && copy-skeleton)
- [x] No lint issues reported

## 3-Way Review (Gemini + Codex + Claude)

### Consensus Findings:
1. **Server utilities**: Confirmed complete and in use
2. **Role utilities**: Initially flagged as incomplete, now fully wired
3. **Init/adopt scaffolding**: >150 lines of duplication missed by jscpd (deferred to TICK)

### Additional Items Identified by Codex:
- Dashboard file-open flows: 3 copies of fetch/select logic across dialogs.js, main.js, files.js
- Dashboard `formatTime`: Duplicate inline definitions in activity.js [Removed in Spec 0074]

### Reviewer Agreement:
- Both Gemini and Codex confirmed server-utils extraction is complete
- Both noted the maintenance log needed updating to reflect completed work

## Summary

Maintenance Run 0004 covered 198 commits since v1.2.0-Cordoba (commit 7591ab9), spanning releases v1.3.0 Doric through v1.5.8 Florence.

**Key Accomplishments:**
- **Code Hygiene**: Deep analysis with ts-prune, depcheck, jscpd. No dead code found. **All 7 duplication clusters resolved.**
- **TypeScript Deduplication** (4 clusters):
  - `utils/server-utils.ts`: escapeHtml, parseJsonBody, isRequestAllowed (22 tests)
  - `utils/roles.ts`: loadRolePrompt, findRolePromptPath (7 tests)
  - `lib/scaffold.ts`: createUserDirs, copyProjectlist, copyResourceTemplates, copyRootFiles, createGitignore, updateGitignore (17 tests)
  - `lib/cli-prompts.ts`: prompt, confirm
  - **229 lines removed** from init.ts/adopt.ts (45% and 38% reduction)
  - **46 new tests** added with full coverage
- **Dashboard JS Deduplication** (3 clusters):
  - `utils.js`: openFileTab, handleMenuKeydown
  - Updated main.js, files.js, dialogs.js, tabs.js
  - **52 net lines removed** with logic centralized
  - Note: Activity rendering was later removed entirely in Spec 0074
- **Documentation Updates**:
  - Updated arch.md with v1.5.x features (dashboard modularization, file browser, remote access, 3D viewer) [note: activity summary later removed by Spec 0074]
  - Consolidated and reordered lessons-learned.md by importance (reduced from 99 to 64 lines)
  - Added v1.5.x and v1.6.0 releases to projectlist.md
  - CLAUDE.md and AGENTS.md already in sync
- **3-Way Review**: Gemini and Codex validated deduplication approach; init/adopt scaffolding identified by Codex and resolved

**Total: 281 lines of duplicate code removed** across TypeScript and JavaScript.
