# Review: Project Management Rework (Spec 0126)

## Summary

Replaced `projectlist.md` as the project tracking registry with GitHub Issues. Reworked `af spawn` CLI to use positional arguments + `--protocol` flag. Added a Tower `/api/overview` endpoint that aggregates builder state from the filesystem with PR/issue data from GitHub. Built a new Dashboard "Work" view that replaces the old StatusPanel with three sections: Active Builders, Pending PRs, and Backlog & Open Bugs.

**Net diff**: +4,640 / -2,824 lines across 72 files (including new tests, docs, and consultation artifacts).

## Spec Compliance

- [x] **GitHub as project registry**: Issues are now the source of truth; `gh` CLI integration layer in `github.ts`
- [x] **Spawn CLI rework**: Positional arg + `--protocol` replaces `-p`/`--issue`; old flags show clear migration errors
- [x] **Scaffold cleanup**: `codev init`/`adopt` no longer create `projectlist.md`; templates removed from skeleton
- [x] **Tower /api/overview endpoint**: Cached endpoint aggregating builders, PRs, and backlog with degraded mode
- [x] **Dashboard Work view**: Three-section layout with builder cards, PR list, backlog grouping, collapsible file panel
- [x] **Dead code removal**: StatusPanel deleted, projectlist functions removed, legacy CSS cleaned up
- [x] **Documentation updates**: CLAUDE.md, AGENTS.md, arch.md, agent-farm.md, workflow-reference.md all updated

## Deviations from Plan

- **PR linked issue not clickable**: The spec says "Linked issue click opens GitHub issue in new tab." The implementation shows linked issue as text because the GitHub repo URL is not available in the overview API response. Would require an additional `gh repo view` call to resolve.
- **Playwright tests not written**: All three reviewers flagged this. Builder worktree lacks Tower infrastructure for E2E tests. Server-side unit tests (24 overview + 6 route tests) cover the API layer. Component rendering validated by build.
- **YAML parsing uses regex instead of js-yaml**: `status.yaml` files are machine-generated by porch with a flat structure. Regex parser is simpler and avoids adding a runtime dependency.
- **CLAUDE.md ≠ AGENTS.md**: These files were already divergent before this project. Both were updated identically for sections this project touches.

## Lessons Learned

### What Went Well
- **Six-phase plan worked**: Dependency ordering (GitHub layer → spawn CLI → scaffold → tower endpoint → work view → cleanup) meant each phase built cleanly on the previous
- **3-way consultation caught a critical bug**: Claude's Phase 5 review identified that `/api/overview` was only registered as a global Tower route, not a workspace-scoped route — the dashboard would have been completely broken
- **Degraded mode design**: Building the overview endpoint to work even when `gh` is unavailable (showing builders but empty PR/backlog sections with error messages) was a good design choice
- **Test-first approach for spawn CLI**: Writing tests before refactoring the spawn command caught edge cases in the zero-padded ID handling and TICK amends flow

### Challenges Encountered
- **Workspace-scoped routing**: The Tower server has two routing layers (global and workspace-scoped) and it's easy to add a global route without realizing the dashboard fetches via workspace-scoped paths. This was caught by consultation but could have been prevented by better understanding of the routing architecture upfront.
- **Vitest 4 mock patterns**: `vi.fn().mockImplementation(...)` doesn't work as a constructor in Vitest 4. Had to use `class` syntax for OverviewCache mocks.
- **Context window pressure**: The session ran out of context during Phase 5 consultation feedback, requiring a continuation summary.

### What Would Be Done Differently
- **Read the Tower routing architecture first**: Before adding any Tower route, trace the full request path from dashboard fetch → workspace dispatch → global fallback
- **Keep phases smaller**: Phase 5 (Work view) was the largest and required the most consultation feedback. Splitting dashboard components into separate phases would have been more manageable.
- **Document excluded tests**: The init.test.ts and E2E tests that reference projectlist are excluded from the test suite but still show up in grep. Should have added comments explaining why they weren't updated.

## Technical Debt

- **Excluded unit test still references projectlist.md**: `init.test.ts` expects `projectlist.md` to be created. This test is excluded from the test suite as flaky and should be updated when un-excluded. (E2E tests `init.e2e.test.ts`, `adopt.e2e.test.ts`, and `af.e2e.test.ts` were fixed during review phase.)
- **Skeleton docs still reference projectlist.md**: `codev-skeleton/` roles, protocols, and command docs reference the old workflow. Should be updated in a coordinated release.
- **PR linked issue not clickable**: Needs repo URL added to the overview API response.
- **No Playwright tests for Work view**: Should be added to the integration test suite post-merge.

## Follow-up Items

- Update skeleton docs for new spawn syntax and GitHub-based workflow (coordinate with next release)
- Add Playwright tests for Work view (requires Tower infrastructure)
- Consider adding repo URL to overview API for clickable PR linked issues
- Reconcile CLAUDE.md/AGENTS.md divergence (MAINTAIN protocol)
- Un-exclude and fix init.test.ts for new scaffold behavior
