{
  "$schema": "../../protocol-schema.json",
  "name": "spider",
  "version": "1.0.0",
  "description": "Specification-driven development with multi-agent consultation",
  "phases": [
    {
      "id": "specify",
      "name": "Specify",
      "description": "Collaborative design exploration and specification",
      "type": "once",
      "prompt": "specify.md",
      "steps": [
        "clarifying_questions",
        "problem_analysis",
        "solution_exploration",
        "open_questions",
        "success_criteria",
        "spec_draft",
        "consultation_1",
        "human_review",
        "consultation_2",
        "spec_final"
      ],
      "consultation": {
        "on": "review",
        "models": ["gemini", "codex", "claude"],
        "type": "spec-review",
        "parallel": true,
        "max_rounds": 3
      },
      "checks": {
        "spec_exists": "test -f codev/specs/${PROJECT_ID}-*.md",
        "has_consultation_section": "grep -q '^## Consultation' codev/specs/${PROJECT_ID}-*.md",
        "no_phases_in_spec": "! grep -qE '^## Phase [0-9]' codev/specs/${PROJECT_ID}-*.md"
      },
      "gate": {
        "name": "spec-approval",
        "description": "Human approves specification before planning",
        "requires": ["spec_final", "consultation_2"],
        "next": "plan"
      }
    },
    {
      "id": "plan",
      "name": "Plan",
      "description": "Implementation planning with phased breakdown",
      "type": "once",
      "prompt": "plan.md",
      "steps": [
        "analyze_spec",
        "identify_phases",
        "define_steps",
        "plan_draft",
        "consultation",
        "human_review",
        "plan_final"
      ],
      "consultation": {
        "on": "review",
        "models": ["gemini", "codex", "claude"],
        "type": "plan-review",
        "parallel": true,
        "max_rounds": 2
      },
      "checks": {
        "plan_exists": "test -f codev/plans/${PROJECT_ID}-*.md",
        "has_phases_json": "grep -q '\"phases\":' codev/plans/${PROJECT_ID}-*.md",
        "has_consultation": "grep -q '^## Consultation' codev/plans/${PROJECT_ID}-*.md"
      },
      "gate": {
        "name": "plan-approval",
        "description": "Human approves plan before implementation",
        "requires": ["plan_final", "consultation"],
        "next": "implement"
      }
    },
    {
      "id": "implement",
      "name": "Implement",
      "description": "Code implementation following the plan",
      "type": "per_plan_phase",
      "prompt": "implement.md",
      "steps": [
        "read_phase",
        "implement_code",
        "self_review",
        "commit"
      ],
      "checks": {
        "build": {
          "command": "npm run build",
          "on_fail": "retry",
          "max_retries": 2
        },
        "typecheck": {
          "command": "npm run typecheck",
          "on_fail": "retry",
          "max_retries": 2
        }
      },
      "transition": {
        "on_complete": "defend",
        "on_fail": "implement"
      }
    },
    {
      "id": "defend",
      "name": "Defend",
      "description": "Testing and verification",
      "type": "per_plan_phase",
      "prompt": "defend.md",
      "steps": [
        "write_tests",
        "run_tests",
        "fix_failures",
        "commit"
      ],
      "checks": {
        "tests": {
          "command": "npm test",
          "on_fail": "implement",
          "max_retries": 1
        },
        "lint": {
          "command": "npm run lint",
          "on_fail": "retry",
          "max_retries": 1
        }
      },
      "consultation": {
        "on": "complete",
        "models": ["gemini", "codex", "claude"],
        "type": "impl-review",
        "parallel": true,
        "max_rounds": 2
      },
      "transition": {
        "on_complete": "evaluate",
        "on_fail": "implement"
      }
    },
    {
      "id": "evaluate",
      "name": "Evaluate",
      "description": "Verify implementation against spec",
      "type": "per_plan_phase",
      "prompt": "evaluate.md",
      "steps": [
        "check_spec_compliance",
        "check_success_criteria",
        "document_deviations"
      ],
      "gate": {
        "name": "phase-complete",
        "description": "Plan phase implementation is verified",
        "requires": ["all_checks_pass", "spec_compliance"],
        "next": "implement"
      },
      "transition": {
        "on_complete": "implement",
        "on_all_phases_complete": "review"
      }
    },
    {
      "id": "review",
      "name": "Review",
      "description": "Final review and lessons learned",
      "type": "once",
      "prompt": "review.md",
      "steps": [
        "create_review_document",
        "document_lessons",
        "final_consultation",
        "create_pr"
      ],
      "consultation": {
        "on": "review",
        "models": ["gemini", "codex", "claude"],
        "type": "pr-ready",
        "parallel": true,
        "max_rounds": 1
      },
      "gate": {
        "name": "pr-ready",
        "description": "Implementation ready for PR",
        "requires": ["review_complete", "all_tests_pass", "consultation"],
        "next": null
      }
    }
  ],
  "signals": {
    "PHASE_COMPLETE": {
      "description": "Signal current phase is complete",
      "transitions_to": "next_phase"
    },
    "BLOCKED": {
      "description": "Signal implementation is blocked",
      "requires": "reason"
    },
    "REVISION_NEEDED": {
      "description": "Signal changes requested",
      "transitions_to": "current_phase"
    },
    "APPROVED": {
      "description": "Signal gate approval received"
    }
  },
  "phase_completion": {
    "build_succeeds": "npm run build 2>&1",
    "tests_pass": "npm test 2>&1",
    "commit_has_code": "git log -1 --name-only --pretty=format: | grep -qE '\\.(ts|tsx|js|jsx|py|go|rs)$'",
    "commit_has_tests": "git log -1 --name-only --pretty=format: | grep -qE '(test|spec)\\.'",
    "commit_has_3way_review": "git log -1 --pretty=format:'%B' | grep -qiE '(3-way|three-way|3way|consultation|gemini.*codex|codex.*gemini)'"
  },
  "defaults": {
    "consultation": {
      "enabled": true,
      "models": ["gemini", "codex", "claude"],
      "parallel": true
    },
    "checks": {
      "build": "npm run build",
      "test": "npm test"
    }
  }
}
