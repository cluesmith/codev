<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Terminal</title>
  <style>
    /* Mobile terminal width lock (Issue #171)
     * On mobile devices, lock terminal width to 40 characters.
     * The terminal container is set to a fixed width that fits 40 chars.
     * xterm.js will then calculate rows based on available height.
     *
     * Calculation: 40 chars at default 15px font with ~0.6 char width ratio = ~360px
     * We use 368px to account for scrollbar and padding.
     */
    @media (max-width: 768px) {
      html, body {
        overflow-x: auto !important;
        overflow-y: hidden !important;
      }

      /* ttyd's terminal container - lock to 40-char width on mobile */
      #terminal-container,
      .xterm,
      .xterm-screen {
        width: 368px !important;
        min-width: 368px !important;
        max-width: 368px !important;
      }
    }
  </style>
</head>
<body>
  <script>
    // Mobile terminal width lock (Issue #171)
    // Force 40 columns on mobile devices by intercepting xterm's resize
    (function() {
      'use strict';

      var MOBILE_COLS = 40;

      function isMobile() {
        return window.innerWidth <= 768 ||
               /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }

      if (!isMobile()) return;

      // Wait for ttyd to initialize the terminal
      function waitForTerminal(callback, maxWait) {
        var start = Date.now();
        var interval = setInterval(function() {
          // ttyd exposes terminal as window.term
          if (window.term && typeof window.term.resize === 'function') {
            clearInterval(interval);
            callback(window.term);
          } else if (Date.now() - start > maxWait) {
            clearInterval(interval);
          }
        }, 50);
      }

      waitForTerminal(function(term) {
        // Get current rows
        var rows = term.rows || 24;

        // Force resize to 40 columns
        term.resize(MOBILE_COLS, rows);

        // Override resize to maintain 40 columns
        var origResize = term.resize.bind(term);
        term.resize = function(cols, newRows) {
          return origResize(MOBILE_COLS, newRows);
        };

        // Send resize command to server via WebSocket
        // ttyd protocol: byte 0 = command type (1 = resize)
        // bytes 1-2 = cols (big endian), bytes 3-4 = rows (big endian)
        if (window.socket && window.socket.readyState === WebSocket.OPEN) {
          var buffer = new Uint8Array(5);
          buffer[0] = 1; // resize command
          buffer[1] = (MOBILE_COLS >> 8) & 0xff;
          buffer[2] = MOBILE_COLS & 0xff;
          buffer[3] = (rows >> 8) & 0xff;
          buffer[4] = rows & 0xff;
          window.socket.send(buffer);
        }
      }, 10000);
    })();
  </script>
</body>
</html>
